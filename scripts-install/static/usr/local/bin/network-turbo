#!/usr/bin/env bash

turbo_cfg="/etc/network-turbo.conf"

proxy_set() {
    http_proxy=$([ ! -f "$turbo_cfg" ] || cat "$turbo_cfg" | grep http_proxy | awk -F '=' '{print $2}')
    if [ -z "$http_proxy" ]; then
        echo "输入代理地址 (例如： http://proxy.example.com:8080):"
        read -r http_proxy
        echo "http_proxy=$http_proxy" >"$turbo_cfg"
    fi

    export http_proxy="$http_proxy"
    export https_proxy="$http_proxy"
    export no_proxy="10.0.0.0/8,172.16.0.0/12,192.168.0.0/16,127.0.0.1,::1,localhost"
}

proxy_unset() {
    unset http_proxy
    unset https_proxy
    unset no_proxy
}

setup_http_proxy() {
    local https_proxy="$1"
    if [ ! -z "$https_proxy" ]; then
        echo "http_proxy=$http_proxy" >"$turbo_cfg"
    fi

    cat >/etc/profile.d/099_proxy.sh <<EOF
source network-turbo && proxy_set
EOF
    chmod +x /etc/profile.d/099_proxy.sh

    echo "setup http proxy"
}

setup_ca_bundle() {
    local cert_file="${1:-"/usr/local/share/ca-certificates/squid-self-signed.crt"}"
    local target_cert_file="/usr/local/share/ca-certificates/squid-self-signed.crt"
    if [ ! -f $cert_file ]; then
        echo "skip: ca bundle file $cert_file not found"
        return
    fi

    cp -vf "$cert_file" "$target_cert_file"
    sudo update-ca-certificates
    local pem_file="/etc/ssl/certs/squid-self-signed.pem"
    if [ -f $pem_file ]; then
        cat >/etc/profile.d/099_ca_bundle.sh <<EOF
export REQUESTS_CA_BUNDLE=$pem_file
EOF
        chmod +x /etc/profile.d/099_ca_bundle.sh
        echo "setup CA Bundle"
    fi
}

case $1 in
help)
    echo "network-turbo help:"
    echo "  set: set turbo config"
    echo "  unset: unset turbo config"
    echo "  reset : reset turbo config"
    echo "  init [proxy [ca_bundle]] : set turbo config in profile"
    ;;
set)
    proxy_set
    echo "已设置加速配置"
    ;;
unset)
    proxy_unset
    echo "已取消加速配置"
    ;;
reset)
    proxy_unset
    rm -f /etc/profile.d/099_proxy.sh
    rm -f /etc/profile.d/099_ca_bundle.sh
    rm -f "$turbo_cfg"
    echo "已重置加速配置"
    ;;
init)
    setup_http_proxy $2
    setup_ca_bundle $3
    echo "已初始化加速配置"
    ;;
*)
    # keep silent
    ;;
esac
